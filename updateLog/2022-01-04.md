# 2022-01-04 log

## 삭제하기 기능

### 삭제하기 JS 추가

 삭제 함수 생성. `delete`는 js에서 예약어이므로 `deleteById` 로 생성함.
 id 값을 value 값이 아닌 text 값으로 받아와야지만 api restcontroller에서 제대로 인식함.

 ```js
 	deleteById: function(){
		var id = $("#id").text();
		
		$.ajax({
			type: "DELETE",
			url: "/api/board/"+id, 
			dataType: "json" 
		}).done(function(resp){
			alert("삭제가 완료되었습니다.");
			location.href = "/";
		}).fail(function(error){
			alert(JSON.stringify(error));
		});
	}
```

### 삭제 - controller 및 Service

```java
	@DeleteMapping("/api/board/{id}")
	public ResponseDto<Integer> deleteById(@PathVariable int id) {
		int result = boardService.글삭제하기(id);
		return new ResponseDto<Integer>(HttpStatus.OK.value(), result);
	}
```

```java
	@Transactional
	public int 글삭제하기(int id) {
		try {
			boardRepository.deleteById(id);
		} catch (EmptyResultDataAccessException e) {
			return -1;
		}
		return 1;
	}
```

### 글쓴이가 아니면 삭제버튼 안보이기

 스프링 시큐리티의 principal id와 board의 id 값이 다르면 안보이도록 설정.

 ```jsp
 	<c:if test="${board.user.id == principal.user.id }">
		<button id="btn-delete" class="btn btn-danger">삭제</button>
	</c:if>
```

![image](https://user-images.githubusercontent.com/84966961/147947869-cb0a986d-c399-4c59-8b87-a8e6c392101d.png)

## 글 수정하기

### 글 수정 기능 흐름

 1. 글 수정 버튼
 2. boardController.updateForm
 3. 수정 뷰 출력
 4. 수정 요청(hidden 값으로 id 포함)
 5. JS Ajax 요청
 6. RestContoller에서 PutMapping으로 받아 Service 호출
 7. Service에서 글 수정(영속화 이후 수정 -> 트랜잭션 종료시 db flush)
 8. 글 수정 완료 상태 리턴
 9. 메인 페이지에서 수정 확인

 같은 방식이기 때문에 어렵지 않다. service에서 영속화를 시켜 트랜잭션 종료시 db에 flush 되는 개념만 알고 있으면 될 것 같다.

 ```java
 	@Transactional
	public int 글수정하기(int id, Board requestBoard) {
		Board board = boardRepository.findById(id).orElseThrow(() -> {
			return new IllegalArgumentException("글 찾기 실패 : 아이디를 찾을 수 없습니다.");
		}); // 영속성 컨텍스트에 영속화 완료
		board.setTitle(requestBoard.getTitle());
		board.setContent(requestBoard.getContent());
		// 서비스 종료시 트랜잭션 종료되면서 `더티체킹`이 일어나면서 db에 flush 함.
		return 1;
	}
```


### 글 수정 완료

![image](https://user-images.githubusercontent.com/84966961/147951814-b744a85d-6ae5-4e09-8ecb-b5efe12581cf.png)

![image](https://user-images.githubusercontent.com/84966961/147951836-11242315-323e-4f5d-9f13-80d522731b7e.png)

![image](https://user-images.githubusercontent.com/84966961/147951851-1c5200d4-1a43-43b6-94f8-be4442fdc77a.png)