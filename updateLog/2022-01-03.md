# 2022-01-03 log

## 글쓰기 기능

### 서머노트 WYSIWIG Editor 사용

 헤더에 서머노트를 위한 스크립트 파일을 임베드함.

```jsp
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
```

 글쓰기를 위한 form을 만듬.

 [관련 주소](https://summernote.org/getting-started/#for-bootstrap-4)

```jsp
 <div class="container">
	<form action="/auth/loginProc" method="post">
		<div class="form-group">
			<label for="username">Title</label>
			<input type="text" class="form-control" placeholder="Enter title" id="title">
		</div>

		<div class="form-group">
			<label for="content">Content</label>
			<textarea class="form-control summernote" rows="5" id="content"></textarea>
		</div>

		<button id="btn-save" class="btn btn-primary">글쓰기 완료</button>
	</form>
</div>

<script>
	$('.summernote').summernote({
		placeholder : 'Enter content',
		tabsize : 2,
		height : 300
	});
</script>
<script type="text/javascript" src="/js/board.js"></script>
```

결과 화면

![image](https://user-images.githubusercontent.com/84966961/147936930-55e19df7-0dc1-4191-aef0-0c56912a09fb.png)

### 글쓰기 뷰 이동

 boardController에 saveForm으로의 이동할 수 있도록 메소드 생성

 ```java
 	// USER 권한 필요
	@GetMapping("/board/saveForm")
	public String saveForm() {
		return "board/saveForm";
	}
```

### 글 쓰기 기능 추가

 board.js 를 생성하여 `글쓰기 완료` 클릭시 AJAX 요청

 ```js
let index = {
	init: function() {
		$("#btn-save").on("click", ()=>{	// this 바인딩을 위한 람다식 . 괄호 함수
			this.save();
		});
	},
	
	save: function(){
		let data = {
			title: $("#title").val(),
			content: $("#content").val()
		};
		
		$.ajax({
			type: "POST",
			url: "/api/board", 
			data: JSON.stringify(data), 
			contentType: "application/json; charset=utf-8", 
			dataType: "json" 
		}).done(function(resp){
			alert("글쓰기가 완료되었습니다.");
			location.href = "/";
		}).fail(function(error){
			alert(JSON.stringify(error));
		});
	}
}

index.init();
 ```

 API로 DATA를 보낼 것이므로 board RestController 생성하고 FK로 UserID가 묶여있으므로 Service에 함께 User 객체 파라미터로 넣어줌.

 여기서 시큐리티 세션에서 PrincipalDetail을 자동주입 받음.

```java
@RestController
public class BoardApiController {
	
	@Autowired
	private BoardService boardService;
	
	@PostMapping("/api/board")
	public ResponseDto<Integer> save(@RequestBody Board board, @AuthenticationPrincipal PrincipalDetail principal) {
		System.out.println("BoardApiController : save 호출됨");
		
		boardService.글쓰기(board, principal.getUser());
		
		return new ResponseDto<Integer>(HttpStatus.OK.value(), 1);
	}
}
```

 BoardService에는 `글쓰기()` 함수를 만들어서 조회수와 User 객체를 board 객체에 담아 JPA가 save하도록 함.

 ```java
 @Service
public class BoardService {

	@Autowired
	private BoardRepository boardRepository;

	@Transactional
	public int 글쓰기(Board board, User user) {
		try {
			board.setCount(0);
			board.setUser(user);
			boardRepository.save(board); // title, content
			return 1;
		} catch (Exception e) {
			e.printStackTrace();
			System.out.println("UserService : 회원가입()" + e.getMessage());
		}
		return -1;
	}
}
```

### 글쓰기 기능 완료

이지윅을 통하여 html 태그의 기능 및 이미지를 넣을 수 있다.

![image](https://user-images.githubusercontent.com/84966961/147938242-ab5582e7-8b51-4ca8-804a-84674e65dd76.png)
